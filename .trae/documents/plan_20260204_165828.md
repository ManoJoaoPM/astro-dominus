# Plano de Otimização e Correção de Sincronização WhatsApp

Vou realizar as seguintes alterações para atender aos requisitos de performance, limpeza de logs e correção de agrupamento de mensagens:

## 1. Otimização do Sync ("Uma Query de Mensagem")
**Arquivo:** `src/services/whatsapp/sync.ts`

*   **Remover Loop de Mensagens:** Vou remover completamente a chamada `evolution.fetchMessages` dentro do loop de chats no método `fullSync`.
*   **Nova Lógica:** O sistema fará apenas **uma** chamada para `fetchChats` (buscar conversas).
    *   As conversas serão criadas/atualizadas no banco com os dados básicos (nome, foto, contador).
    *   As mensagens **não** serão baixadas massivamente no início. O sistema confiará no **Webhook** para novas mensagens e na carga sob demanda (se implementada no frontend) ou apenas no fluxo "daqui para frente".
*   **Benefício:** Isso elimina as múltiplas requisições que estavam travando o sistema e atende ao pedido de "uma query".

## 2. Correção de "Juntando Mensagens" e Grupos
**Arquivos:** `src/services/whatsapp/sync.ts` e `src/app/api/webhooks/evolution/route.ts`

*   **Validação Rigorosa de ID:** Adicionarei verificação extra para garantir que `remoteJid` seja válido e único antes de criar ou buscar uma conversa.
*   **Filtro de Grupos:** Reforçar o filtro `!remoteJid.includes('@g.us')` em todos os pontos de entrada para garantir que grupos nunca sejam criados como conversas.
*   **Tratamento de Broadcast:** Garantir que `status@broadcast` seja ignorado.

## 3. Limpeza de Logs e Tratamento de Erros 404
**Arquivo:** `src/services/evolution/api.ts`

*   **Remover Logs:** Excluir os `console.log` de requisições da API.
*   **Tratar Erro 404:** Implementar tratamento silencioso para erros 404 (instância não encontrada) no método `get` e `post`, retornando `null` em vez de lançar exceção e poluir o terminal.

## 4. Verificação de Integridade
*   Se possível, sugerir ao usuário (via mensagem final) que limpe o banco de dados (`messages` e `conversations`) para remover as mensagens que foram incorretamente agrupadas anteriormente, pois o código corrigido impedirá novos erros, mas não conserta o passado automaticamente.

Essas mudanças alinham o sistema para ser leve, silencioso e focado em eventos em tempo real (webhook).
