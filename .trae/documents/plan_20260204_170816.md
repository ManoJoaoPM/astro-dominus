# Correção e Ajuste Fino do Observador WhatsApp

Baseado na sua solicitação de que "não está funcionando corretamente" e nos requisitos conflitantes ("apenas uma query" vs "trazer 20 mensagens"), identifiquei que a otimização anterior foi agressiva demais ao remover totalmente a busca de mensagens, deixando os chats vazios.

Vou implementar uma lógica híbrida que atende exatamente ao que você pediu:

## 1. Ajuste no Serviço de Sincronização (`sync.ts`)

Vou restaurar a busca de mensagens, mas com **regras condicionais estritas** para não sobrecarregar o sistema ("vários queries"):

*   **Cenário 1: Instalação Limpa (Banco Vazio)**
    *   Busca as **10 conversas** mais recentes.
    *   Para cada uma, busca apenas as **20 mensagens** mais recentes.
    *   Isso garante que o usuário tenha histórico inicial sem fazer centenas de requisições.

*   **Cenário 2: Atualização (Banco Já Existe)**
    *   Busca os chats para atualizar fotos e nomes.
    *   **NÃO busca mensagens antigas.** O sistema assumirá que o **Webhook** já capturou as mensagens novas "daqui para frente".
    *   Isso atende ao pedido de "uma query de mensagem e depois ele deve buscar por novas...".

## 2. Reforço no Webhook (`route.ts`)

*   Garantir que a lógica de "Upsert" (Inserir ou Atualizar) esteja blindada contra duplicidades.
*   Manter os filtros de Grupos e Broadcasts ativos.
*   Verificar se a extração do `remoteJid` está cobrindo todos os casos (ex: mensagens enviadas pelo próprio usuário vs recebidas).

## 3. Verificação de Logs e Erros
*   Confirmar que o tratamento de erro 404 silencioso está funcionando (já implementado no `api.ts`, mas vou revisar se todos os métodos usam).

Essa abordagem resolve o problema dos "chats vazios" na primeira instalação e o problema de "excesso de queries" no uso diário.
